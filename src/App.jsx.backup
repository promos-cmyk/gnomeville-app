import React, { useMemo, useState, useEffect } from "react";

/* =============================================================================
   Backend Wiring Notes
============================================================================= */

const API_BASE = ""; // e.g. "https://api.gnomeville.app"
const USE_MOCK = true;

// Simple helper for fetch with JSON
async function jfetch(path, init) {
  const res = await fetch(`${API_BASE}${path}`, {
    headers: { "Content-Type": "application/json", ...(init?.headers || {}) },
    credentials: "include",
    ...init,
  });
  if (!res.ok) throw new Error(await res.text().catch(() => res.statusText));
  return res.json();
}
// Simple helper for multipart (photo)
async function mfetch(path, form, init) {
  const res = await fetch(`${API_BASE}${path}`, {
    method: "POST",
    body: form,
    credentials: "include",
    ...(init || {}),
  });
  if (!res.ok) throw new Error(await res.text().catch(() => res.statusText));
  return res.json();
}

/* =============================================================================
   API CONTRACT (implement these in your backend)
============================================================================= */
const api = {
  // Auth / session
  verify: async (payload) => {
    if (USE_MOCK) return { ok: true, userId: "demo-user", email: payload.email || "", phone: payload.phone || "" };
    return jfetch("/api/auth/verify", { method: "POST", body: JSON.stringify(payload) });
  },

  // Participant scanning, reward listing, redemption, and photo upload
  scan: async (payload) => {
    if (USE_MOCK) return { ok: true };
    return jfetch("/api/scans", { method: "POST", body: JSON.stringify(payload) });
  },
  uploadPhoto: async (payload) => {
    if (USE_MOCK) return { ok: true, photoUrl: "data:mock", subId: "SUB-" + Math.random().toString(36).slice(2, 10).toUpperCase() };
    const form = new FormData();
    form.append("gnomeId", String(payload.gnomeId));
    form.append("photo", payload.file);
    return mfetch("/api/photos", form);
  },
  getRewards: async () => {
    if (USE_MOCK) return { ok: true, rewards: [] };
    return jfetch("/api/rewards", { method: "GET" });
  },
  redeem: async (payload) => {
    if (USE_MOCK) return { ok: true, redeemed: true };
    return jfetch("/api/redeem", { method: "POST", body: JSON.stringify(payload) });
  },

  // Partners (bidding)
  getBids: async () => {
    if (USE_MOCK) return { ok: true, bids: [] };
    return jfetch("/api/partners/bids", { method: "GET" });
  },
  placeBid: async (payload) => {
    if (USE_MOCK) return { ok: true };
    return jfetch("/api/partners/bid", { method: "POST", body: JSON.stringify(payload) });
  },

  // Admin: golden schedule, invites, audits
  scheduleGolden: async (payload) => {
    if (USE_MOCK) return { ok: true };
    return jfetch("/api/admin/golden/schedule", { method: "POST", body: JSON.stringify(payload) });
  },
  sendInvite: async (payload) => {
    if (USE_MOCK) return { ok: true, code: "INV-" + Math.random().toString(36).slice(2, 8).toUpperCase() };
    return jfetch("/api/admin/invites", { method: "POST", body: JSON.stringify(payload) });
  },
  getAudits: async () => {
    if (USE_MOCK) {
      return {
        ok: true,
        items: Array.from({ length: 8 }).map((_, i) => ({
          ts: `2025-10-0${i + 1} 19:${(10 + i).toString().padStart(2, "0")}`,
          user: `user${i + 1}@example.com`,
          reward: "20% off",
          code: `WF-20-0${i + 1}`,
          store: "WildFlower Jax",
        })),
      };
    }
    return jfetch("/api/admin/audits", { method: "GET" });
  },

  // Advertiser: login (one-time), offers, scan & redeem
  advLogin: async (payload) => {
    if (USE_MOCK) return { ok: true, session: { email: payload.email } };
    return jfetch("/api/advertisers/login", { method: "POST", body: JSON.stringify(payload) });
  },
  advList: async () => {
    if (USE_MOCK) return { ok: true, offers: [] };
    return jfetch("/api/advertisers/offers", { method: "GET" });
  },
  advSave: async (payload) => {
    if (USE_MOCK) return { ok: true };
    return jfetch("/api/advertisers/offers", { method: "POST", body: JSON.stringify(payload) });
  },
  advScan: async (payload) => {
    if (USE_MOCK)
      return {
        ok: true,
        code: payload.code.toUpperCase(),
        used: !!window.__oneTimeUsed?.[payload.code.toUpperCase()],
        photoUrl: window.__photos?.[payload.code.toUpperCase()] || null,
      };
    return jfetch("/api/advertisers/scan", { method: "POST", body: JSON.stringify(payload) });
  },
  advRedeem: async (payload) => {
    if (USE_MOCK) return { ok: true, redeemed: true };
    return jfetch("/api/advertisers/redeem", { method: "POST", body: JSON.stringify(payload) });
  },
};

/* =============================================================================
   Local demo store (works when USE_MOCK=true)
============================================================================= */
if (!window.__photos) window.__photos = {};
if (!window.__oneTimeUsed) window.__oneTimeUsed = {};
if (!window.__adInv) window.__adInv = {};
if (window.__adSession === undefined) window.__adSession = null;
if (!window.__adOffers) window.__adOffers = [];

/* =============================================================================
   Seeds
============================================================================= */
const GNOMES = [
  { id: 1, name: "Surfer", venue: "Jax Pier", emoji: "üèÑ", riddle: "He rides waves by day, chills by night. Look for him where the sea meets the bite.", next: 2 },
  { id: 2, name: "Bartender", venue: "The Lemon Bar", emoji: "üçπ", riddle: "Tropical tunes and citrus hues, your next gnome waits where the sunset views.", next: 3 },
  { id: 3, name: "Fisherman", venue: "Angie's Subs", emoji: "üé£", riddle: "He casts his line near the ocean blue, your next gnome skates with a daring crew.", next: 4 },
  { id: 4, name: "Skater", venue: "South Beach Skate Park", emoji: "üõπ", riddle: "Kick-push to the spot where strings ring true.", next: 5 },
  { id: 5, name: "Musician", venue: "Green Room", emoji: "üé∏", riddle: "Where riffs are poured and crowds sway, seek the watchful bay.", next: 6 },
  { id: 6, name: "Lifeguard", venue: "Lifeguard Station", emoji: "üõü", riddle: "Red floats, high posts; find foam and toast.", next: 7 },
  { id: 7, name: "Party", venue: "Lynch‚Äôs Irish Pub", emoji: "üç∫", riddle: "Shamrocks and shanties, then stretch and breathe.", next: 8 },
  { id: 8, name: "Yoga", venue: "Seawalk Pavilion", emoji: "üßò", riddle: "Breathe in brine where lines meet pine.", next: 9 },
  { id: 9, name: "Firefighter", venue: "Jax Beach Fire", emoji: "üöí", riddle: "Sirens low, ink will flow.", next: 10 },
  { id: 10, name: "Tattoo Artist", venue: "13th Floor Tattoo", emoji: "üíÄ", riddle: "Final mark, claim your spark.", next: null },
];

const REWARDS = {
  perGnome: { label: "20% off up to $500", codePrefix: "WF-20-" },
  golden: { label: "$1,000 Golden Gnome" },
  grand: { label: "$2,000 Grand Prize" },
};

const uid = () => Math.random().toString(36).slice(2, 10).toUpperCase();

/* =============================================================================
   Shared UI
============================================================================= */
function ProgressBar({ value, total }) {
  const pct = Math.round((value / total) * 100);
  return (
    <div className="space-y-1">
      <div className="text-xs text-gray-600">Progress {value}/{total} ({pct}%)</div>
      <div className="h-2 w-full rounded bg-gray-200">
        <div className="h-2 rounded bg-black" style={{ width: `${pct}%` }} />
      </div>
    </div>
  );
}

function Card({ title, right, children }) {
  return (
    <div className="rounded-2xl border p-4 shadow-sm bg-white">
      <div className="flex items-center justify-between mb-3">
        <h3 className="font-semibold">{title}</h3>
        {right}
      </div>
      {children}
    </div>
  );
}

/* =============================================================================
   Participant
============================================================================= */
function ParticipantApp() {
  const [user, setUser] = useState(null);
  const [found, setFound] = useState([]);
  const [photoOk, setPhotoOk] = useState({});
  const [photoById, setPhotoById] = useState({});
  const [message, setMessage] = useState(null);
  const [qrText, setQrText] = useState("");

  const currentId = useMemo(() => {
    const notFound = GNOMES.find((g) => !found.includes(g.id));
    return notFound ? notFound.id : null;
  }, [found]);
  const current = GNOMES.find((g) => g.id === currentId) || GNOMES[0];

  async function verify() {
    try {
      const res = await api.verify({ email: user?.email, phone: user?.phone });
      setUser((u) => ({ ...(u || {}), userId: res.userId }));
    } catch (e) {
      alert(`Verify failed: ${e.message || e}`);
    }
  }

  async function simulateScan() {
    const match = qrText.match(/(\d+)/);
    if (!match) return setMessage("No gnome ID detected in QR.");
    const id = Number(match[1]);
    if (!GNOMES.some((g) => g.id === id)) return setMessage("Invalid gnome code.");
    if (found.includes(id)) return setMessage(`Already checked in for #${id}.`);
    const expectedId = currentId;
    if (expectedId !== id) return setMessage(`You're on #${expectedId}. Scan that gnome first.`);
    try {
      await api.scan({ gnomeId: id });
      setFound((f) => [...f, id]);
      setMessage(`Check-in success for #${id} ‚Äî ${GNOMES[id - 1].name}!`);
      setQrText("");
    } catch (e) {
      alert(`Scan error: ${e.message || e}`);
    }
  }

  async function onUploadPhoto(gnomeId, e) {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const res = await api.uploadPhoto({ gnomeId, file });
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = String(reader.result || "");
        setPhotoById((m) => ({ ...m, [gnomeId]: dataUrl }));
        setPhotoOk((p) => ({ ...p, [gnomeId]: true }));

        const code = REWARDS.perGnome.codePrefix + String(gnomeId).padStart(2, "0");
        // Demo store for advertiser verification flow:
        window.__photos[code] = dataUrl;
      };
      reader.readAsDataURL(file);
    } catch (e) {
      alert(`Upload failed: ${e.message || e}`);
    }
  }

  function rewardsUnlocked() {
    return found.map((id) => ({
      id,
      code: REWARDS.perGnome.codePrefix + String(id).padStart(2, "0"),
      unlocked: !!photoOk[id],
    }));
  }

  async function redeem(code) {
    try {
      if (window.__oneTimeUsed && window.__oneTimeUsed[code]) {
        alert("Already redeemed.");
        return;
      }
      const res = await api.redeem({ code });
      if (res.redeemed) {
        if (!window.__oneTimeUsed) window.__oneTimeUsed = {};
        window.__oneTimeUsed[code] = true;
        alert(`Redeemed ${code}`);
      }
    } catch (e) {
      alert(`Redeem failed: ${e.message || e}`);
    }
  }

  const grandUnlocked = found.length === GNOMES.length;

  return (
    <div className="space-y-6">
      {/* Simple verify strip (backend-friendly) */}
      <Card
        title="Account"
        right={
          <button
            className={`rounded px-3 py-1 text-sm ${user?.userId ? "bg-green-600 text-white" : "bg-black text-white"}`}
            onClick={verify}
          >
            {user?.userId ? "Verified" : "Verify"}
          </button>
        }
      >
        <div className="grid md:grid-cols-3 gap-2">
          <input
            className="rounded border px-3 py-2 text-sm"
            placeholder="Email"
            value={user?.email || ""}
            onChange={(e) => setUser((u) => ({ ...(u || {}), email: e.target.value }))}
          />
          <input
            className="rounded border px-3 py-2 text-sm"
            placeholder="Phone"
            value={user?.phone || ""}
            onChange={(e) => setUser((u) => ({ ...(u || {}), phone: e.target.value }))}
          />
          <div className="text-xs text-gray-500 self-center">{user?.userId ? `User: ${user.userId}` : "Not verified"}</div>
        </div>
      </Card>

      <div className="flex flex-col md:flex-row md:items-start gap-6">
        <Card title="Current Clue" right={<span className="text-sm text-gray-500">Order-locked</span>}>
          <div className="aspect-video w-full bg-gray-100 rounded-xl mb-3 flex items-center justify-center text-5xl">
            {current.emoji}
          </div>
          <div className="text-sm text-gray-600 mb-2">#{current.id} ‚Äî {current.name} @ {current.venue}</div>
          <p className="italic">‚Äú{current.riddle}‚Äù</p>
          <div className="mt-4 flex flex-col sm:flex-row gap-2">
            <input value={qrText} onChange={(e) => setQrText(e.target.value)} placeholder="Paste/enter QR (e.g. gnome:1)" className="w-full sm:w-auto flex-1 rounded-lg border px-3 py-2" />
            <button onClick={simulateScan} className="rounded-lg bg-black text-white px-4 py-2">Scan / Check-in</button>
          </div>
          {message && <p className="mt-2 text-sm text-gray-700">{message}</p>}
        </Card>

        <div className="w-full md:max-w-sm space-y-4">
          <Card title="Your Progress">
            <ProgressBar value={found.length} total={GNOMES.length} />
            <div className="mt-3 grid grid-cols-5 gap-2">
              {GNOMES.map((g) => (
                <div key={g.id} className={`rounded-lg border text-center p-2 text-xs ${found.includes(g.id) ? "bg-black text-white" : "bg-white"}`}>
                  {g.emoji}
                  <div>#{g.id}</div>
                </div>
              ))}
            </div>
          </Card>

          <Card title="Photo / Shirt Verification">
            <p className="text-sm text-gray-600 mb-2">Upload your photo with each found gnome to unlock its coupon code.</p>
            <div className="grid grid-cols-1 gap-2">
              {found.map((id) => (
                <div key={id} className="border rounded-lg p-2 text-sm">
                  <div className="flex items-center justify-between mb-2">
                    <span className="font-medium">#{id} {GNOMES[id - 1].name}</span>
                    <span className={`text-xs px-2 py-0.5 rounded ${photoOk[id] ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-600"}`}>
                      {photoOk[id] ? "Photo attached" : "Add photo"}
                    </span>
                  </div>
                  <div className="flex items-center gap-3">
                    <input type="file" accept="image/*" onChange={(e) => onUploadPhoto(id, e)} />
                    {photoById[id] && <img src={photoById[id]} alt={`#${id}`} className="w-12 h-12 object-cover rounded border" />}
                  </div>
                </div>
              ))}
            </div>
          </Card>
        </div>
      </div>

      <Card title="Rewards Wallet">
        <div className="grid md:grid-cols-3 gap-3">
          {/* Per-gnome */}
          {rewardsUnlocked().map((r) => {
            const used = !!(window.__oneTimeUsed && window.__oneTimeUsed[r.code]);
            return (
              <div key={r.id} className={`rounded-xl border p-3 ${r.unlocked ? "" : "opacity-60"}`}>
                <div className="text-sm text-gray-500">Per Gnome</div>
                <div className="font-semibold">{REWARDS.perGnome.label}</div>
                <div className="mt-2 text-xs">Code</div>
                <div className="font-mono text-lg">{r.unlocked ? (used ? "Redeemed" : r.code) : "Locked ‚Äî upload photo"}</div>
                {r.unlocked && !used && (
                  <button onClick={() => redeem(r.code)} className="mt-2 rounded bg-black text-white px-3 py-1 text-sm">Redeem</button>
                )}
                {r.unlocked && used && <div className="mt-2 text-xs text-green-700">One-time redemption used</div>}
                <div className="mt-2 text-xs text-gray-500">Show at WildFlower checkout.</div>
              </div>
            );
          })}

          {/* Golden (placeholder; bound by advertiser page in this prototype) */}
          <div className="rounded-xl border p-3">
            <div className="text-sm text-gray-500">Special</div>
            <div className="font-semibold">{REWARDS.golden.label}</div>
            <div className="mt-2 text-xs">Status</div>
            <div className="font-mono">Watch for Golden drop</div>
          </div>

          {/* Grand */}
          <div className="rounded-xl border p-3">
            <div className="text-sm text-gray-500">Milestone</div>
            <div className="font-semibold">{REWARDS.grand.label}</div>
            <div className="mt-2 text-xs">Status</div>
            <div className="font-mono">{grandUnlocked ? "Eligible ‚Äî see staff" : `Find all ${GNOMES.length} gnomes`}</div>
          </div>
        </div>
      </Card>
    </div>
  );
}

/* =============================================================================
   Partner (bidding with countdown)
============================================================================= */
function countdownTo(deadline) {
  const now = Date.now();
  const diff = Math.max(0, deadline - now);
  const h = Math.floor(diff / 3_600_000);
  const m = Math.floor((diff % 3_600_000) / 60_000);
  const s = Math.floor((diff % 60_000) / 1000);
  return `${h}h ${m}m ${s}s`;
}

function PartnerPortal() {
  const [bids, setBids] = useState(
    GNOMES.slice(0, 6).map((g, i) => ({ gnome: g, current: 200 + 20 * i, myBid: "", endsAt: Date.now() + (i + 1) * 60_000 }))
  );

  useEffect(() => {
    (async () => {
      try {
        const res = await api.getBids();
        if (res?.bids?.length) {
          // transform if needed
        }
      } catch {}
    })();
  }, []);

  const [, setTick] = useState(0);
  useEffect(() => {
    const id = setInterval(() => setTick((t) => t + 1), 1000);
    return () => clearInterval(id);
  }, []);

  async function placeBid(index) {
    const amount = Number(bids[index].myBid);
    if (!amount || amount <= bids[index].current) return;
    try {
      await api.placeBid({ gnomeId: bids[index].gnome.id, amount });
      setBids((rows) => rows.map((r, i) => (i === index ? { ...r, current: amount, myBid: "" } : r)));
    } catch (e) {
      alert(`Bid failed: ${e.message || e}`);
    }
  }

  return (
    <div className="space-y-6">
      <Card title="Bidding (Monthly)">
        <div className="overflow-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b">
                <th className="py-2 pr-3">Gnome</th>
                <th className="py-2 pr-3">Current Bid</th>
                <th className="py-2 pr-3">Time Left</th>
                <th className="py-2 pr-3">Place Bid</th>
              </tr>
            </thead>
            <tbody>
              {bids.map((row, i) => (
                <tr key={row.gnome.id} className="border-b">
                  <td className="py-2 pr-3">{row.gnome.emoji} #{row.gnome.id} {row.gnome.name}</td>
                  <td className="py-2 pr-3 font-mono">${row.current}</td>
                  <td className="py-2 pr-3">{countdownTo(row.endsAt)}</td>
                  <td className="py-2 pr-3">
                    <div className="flex items-center gap-2">
                      <input
                        className="rounded border px-2 py-1 w-24"
                        placeholder="$"
                        value={row.myBid}
                        onChange={(e) => setBids((rows) => rows.map((r, j) => (i === j ? { ...r, myBid: e.target.value } : r)))}
                      />
                      <button onClick={() => placeBid(i)} className="rounded bg-black text-white px-3 py-1">Bid</button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>

      <Card title="Analytics Snapshot">
        <div className="grid md:grid-cols-4 gap-3 text-center">
          <Metric label="QR Scans" value="12,480"/>
          <Metric label="Unique Visitors" value="4,109"/>
          <Metric label="Avg Dwell" value="6m 12s"/>
          <Metric label="Social Tags" value="#Gnomeville 3.1k"/>
        </div>
      </Card>
    </div>
  );
}
function Metric({ label, value }) {
  return (
    <div className="rounded-2xl border p-4">
      <div className="text-sm text-gray-500">{label}</div>
      <div className="text-2xl font-bold">{value}</div>
    </div>
  );
}

/* =============================================================================
   Admin ‚Äî Golden schedule, Invite Advertiser, Audits
============================================================================= */
function AdminTools() {
  const [windowMinutes, setWindowMinutes] = useState(30);
  const [selectedGnome, setSelectedGnome] = useState(1);
  const [hint, setHint] = useState("Somewhere that smells like salt and soundwaves.");
  const [scheduled, setScheduled] = useState(null);

  const [inviteEmail, setInviteEmail] = useState("");
  const [lastInvite, setLastInvite] = useState(null);

  const [audits, setAudits] = useState([]);

  useEffect(() => {
    (async () => {
      try {
        const res = await api.getAudits();
        setAudits(res.items || []);
      } catch {}
    })();
  }, []);

  async function schedule() {
    const start = Date.now() + 5_000; // demo: 5s from now
    const end = start + windowMinutes * 60_000;
    const payload = { gnomeId: selectedGnome, start, end, hint };
    try {
      await api.scheduleGolden(payload);
      setScheduled(payload);
      alert("Golden window scheduled.");
    } catch (e) {
      alert(`Schedule failed: ${e.message || e}`);
    }
  }

  async function sendInvite() {
    try {
      const res = await api.sendInvite({ email: inviteEmail });
      const code = res.code || "INV-" + uid();
      if (USE_MOCK) {
        if (!window.__adInv) window.__adInv = {};
        window.__adInv[code] = { email: inviteEmail, used: false };
      }
      setLastInvite({ email: inviteEmail, code });
      setLastInvite({ email: inviteEmail, code });
      setInviteEmail("");
      alert(`Invite generated for ${lastInvite?.email || inviteEmail}`);
    } catch (e) {
      alert(`Invite failed: ${e.message || e}`);
    }
  }

  return (
    <div className="space-y-6">
      <Card title="Golden Gnome Scheduler">
        <div className="grid md:grid-cols-3 gap-3">
          <div>
            <label className="text-sm">Gnome</label>
            <select className="w-full rounded border px-3 py-2" value={selectedGnome} onChange={(e) => setSelectedGnome(Number(e.target.value))}>
              {GNOMES.map((g) => (
                <option key={g.id} value={g.id}>#{g.id} {g.name} ‚Äî {g.venue}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="text-sm">Window (minutes)</label>
            <input type="number" className="w-full rounded border px-3 py-2" value={windowMinutes} onChange={(e) => setWindowMinutes(Number(e.target.value))} />
          </div>
          <div>
            <label className="text-sm">Hint Text</label>
            <input className="w-full rounded border px-3 py-2" value={hint} onChange={(e) => setHint(e.target.value)} />
          </div>
        </div>
        <button onClick={schedule} className="mt-4 rounded bg-black text-white px-4 py-2">Schedule Drop</button>
        {scheduled && (
          <div className="mt-3 text-sm">
            Scheduled in 5s ‚Üí #{scheduled.gnomeId} for {Math.round((scheduled.end - scheduled.start) / 60_000)}m. Hint: <span className="italic">{scheduled.hint}</span>
          </div>
        )}
      </Card>

      <Card title="Invite Advertiser (One-time code)">
        <div className="grid md:grid-cols-3 gap-3 items-end">
          <label className="grid gap-1">
            <span className="text-sm">Advertiser Email</span>
            <input className="rounded border px-3 py-2" value={inviteEmail} onChange={(e)=>setInviteEmail(e.target.value)} placeholder="brand@email.com" />
          </label>
          <button onClick={sendInvite} className="rounded bg-black text-white px-4 py-2 h-10">Generate Invite</button>
          {lastInvite && (
            <div className="text-sm">
              <div>Last Invite</div>
              <div>Email: <span className="font-mono">{lastInvite.email}</span></div>
              <div>One-time Code: <span className="font-mono">{lastInvite.code}</span></div>
            </div>
          )}
        </div>
        <p className="text-xs text-gray-500 mt-2">Share the one-time code with the advertiser; they‚Äôll enter it on the Advertiser page with their email.</p>
      </Card>

      <Card title="Redemption Audit">
        <div className="overflow-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b">
                <th className="py-2 pr-3">TS</th>
                <th className="py-2 pr-3">User</th>
                <th className="py-2 pr-3">Reward</th>
                <th className="py-2 pr-3">Code</th>
                <th className="py-2 pr-3">Store</th>
              </tr>
            </thead>
            <tbody>
              {audits.map((r, i) => (
                <tr key={i} className="border-b">
                  <td className="py-2 pr-3">{r.ts}</td>
                  <td className="py-2 pr-3">{r.user}</td>
                  <td className="py-2 pr-3">{r.reward}</td>
                  <td className="py-2 pr-3 font-mono">{r.code}</td>
                  <td className="py-2 pr-3">{r.store}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  );
}

/* =============================================================================
   Advertiser
============================================================================= */
function isActiveOffer(o) {
  if (o.alwaysOn) return true;
  const now = Date.now();
  if (o.start == null || o.end == null) return false;
  return now >= o.start && now <= o.end;
}

function AdvertiserPage() {
  const [ses, setSes] = useState(window.__adSession);
  const [email, setEmail] = useState("");
  const [code, setCode] = useState("");
  const [scope, setScope] = useState("GOLDEN");
  const [gnomeId, setGnomeId] = useState(1);
  const [coupon, setCoupon] = useState("AD-GOLD-20");
  const [alwaysOn, setAlwaysOn] = useState(true);
  const [start, setStart] = useState("");
  const [end, setEnd] = useState("");

  const [offers, setOffers] = useState([]);
  const [scanCode, setScanCode] = useState("");
  const [look, setLook] = useState(null);

  useEffect(() => {
    (async () => {
      try {
        const res = await api.advList();
        setOffers(res.offers || []);
      } catch {}
    })();
  }, []);

  async function login() {
    try {
      if (USE_MOCK) {
        const inv = Object.entries(window.__adInv || {}).find(([c, v]) => c === code && v.email === email && !v.used);
        if (!inv) return alert("Invalid email or code (or already used).");
        inv[1].used = true;
      }
      const res = await api.advLogin({ email, code });
      window.__adSession = { email: res.session?.email || email };
      setSes(window.__adSession);
    } catch (e) {
      alert(`Login failed: ${e.message || e}`);
    }
  }
  function logout() {
    window.__adSession = null;
    setSes(null);
  }

  async function saveOffer() {
    if (!ses) return alert("Log in first.");
    const body = {
      scope,
      gnomeId: scope === "SPECIFIC" ? gnomeId : undefined,
      coupon: coupon.toUpperCase(),
      alwaysOn,
      start: alwaysOn ? undefined : (start ? new Date(start).getTime() : undefined),
      end: alwaysOn ? undefined : (end ? new Date(end).getTime() : undefined),
    };
    try {
      await api.advSave(body);
      setOffers((o) => [...o, { owner: ses.email, ...body }]);
      alert("Offer saved.");
    } catch (e) {
      alert(`Save failed: ${e.message || e}`);
    }
  }

  async function doLookup() {
    try {
      const res = await api.advScan({ code: scanCode.trim().toUpperCase() });
      setLook({ code: res.code, used: res.used, photoUrl: res.photoUrl });
  async function markRedeemed() {
    if (!look) return;
    try {
      const res = await api.advRedeem({ code: look.code });
      if (USE_MOCK) {
        if (!window.__oneTimeUsed) window.__oneTimeUsed = {};
        window.__oneTimeUsed[look.code] = true;
      }
      setLook({ ...look, used: true });
      alert(`Redeemed ${look.code}`);
    } catch (e) {
      alert(`Redeem failed: ${e.message || e}`);
    }
  }
    } catch (e) {
      alert(`Redeem failed: ${e.message || e}`);
    }
  }

  return (
    <div className="space-y-6">
      {!ses ? (
        <Card title="Advertiser Login">
          <div className="grid md:grid-cols-3 gap-3 items-end">
            <label className="grid gap-1">
              <span className="text-sm">Email</span>
              <input className="rounded border px-3 py-2" value={email} onChange={(e)=>setEmail(e.target.value)} placeholder="you@brand.com" />
            </label>
            <label className="grid gap-1">
              <span className="text-sm">One-time Code</span>
              <input className="rounded border px-3 py-2" value={code} onChange={(e)=>setCode(e.target.value.toUpperCase())} placeholder="INV-XXXXXX" />
            </label>
            <button onClick={login} className="rounded bg-black text-white px-4 py-2 h-10">Sign In</button>
          </div>
          <p className="text-xs text-gray-500 mt-2">Ask Admin for an invite. Codes are single-use.</p>
        </Card>
      ) : (
        <>
          <Card title="Create / Update Coupon Offer" right={<button onClick={logout} className="text-sm underline">Logout</button>}>
            <div className="grid md:grid-cols-5 gap-3">
              <label className="grid gap-1">
                <span className="text-sm">Scope</span>
                <select className="rounded border px-3 py-2" value={scope} onChange={(e)=>setScope(e.target.value)}>
                  <option value="ALL">All Gnomes</option>
                  <option value="GOLDEN">Golden Gnome</option>
                  <option value="SPECIFIC">Specific Gnome</option>
                </select>
              </label>
              <label className="grid gap-1">
                <span className="text-sm">Gnome ID</span>
                <input type="number" className="rounded border px-3 py-2" value={gnomeId} onChange={(e)=>setGnomeId(Number(e.target.value)||1)} />
              </label>
              <label className="grid gap-1 md:col-span-2">
                <span className="text-sm">Coupon Code</span>
                <input className="rounded border px-3 py-2" value={coupon} onChange={(e)=>setCoupon(e.target.value.toUpperCase())} />
              </label>
              <label className="flex items-center gap-2 mt-6">
                <input type="checkbox" checked={alwaysOn} onChange={(e)=>setAlwaysOn(e.target.checked)} />
                <span className="text-sm">Always on</span>
              </label>
              {!alwaysOn && (
                <>
                  <label className="grid gap-1">
                    <span className="text-sm">Start</span>
                    <input type="datetime-local" className="rounded border px-3 py-2" value={start} onChange={(e)=>setStart(e.target.value)} />
                  </label>
                  <label className="grid gap-1">
                    <span className="text-sm">End</span>
                    <input type="datetime-local" className="rounded border px-3 py-2" value={end} onChange={(e)=>setEnd(e.target.value)} />
                  </label>
                </>
              )}
            </div>
            <div className="mt-3 flex items-center gap-2">
              <button onClick={saveOffer} className="rounded bg-black text-white px-4 py-2">Save Offer</button>
            </div>
          </Card>

          <Card title="Scan Coupon / Verify Photo">
            <div className="grid md:grid-cols-3 gap-3 items-end">
              <label className="grid gap-1">
                <span className="text-sm">Coupon Code</span>
                <input className="rounded border px-3 py-2" value={scanCode} onChange={(e)=>setScanCode(e.target.value.toUpperCase())} placeholder="WF-20-01 / AD-GOLD-20" />
              </label>
              <button onClick={doLookup} className="rounded bg-black text-white px-4 py-2 h-10">Lookup</button>
              {look && (
                <div className="text-sm">
                  <div>Used: <span className={`font-mono ${look.used ? "text-red-600" : "text-green-700"}`}>{String(!!look.used).toUpperCase()}</span></div>
                </div>
              )}
            </div>
            {look && (
              <div className="mt-3 flex items-center gap-4">
                <div className="text-sm">
                  <div className="mb-1">Attached Participant Photo</div>
                  {look.photoUrl ? (
                    <img src={look.photoUrl} alt="proof" className="w-32 h-32 object-cover rounded border" />
                  ) : (
                    <div className="text-xs text-gray-500">No photo found for this code.</div>
                  )}
                </div>
                <div className="ml-auto">
                  <button
                    disabled={!!look.used}
                    onClick={markRedeemed}
                    className={`rounded px-4 py-2 ${look.used ? "bg-gray-300 text-gray-600" : "bg-black text-white"}`}
                  >
                    {look.used ? "Already Redeemed" : "Mark Redeemed (One-time)"}
                  </button>
                </div>
              </div>
            )}
          </Card>
        </>
      )}
    </div>
  );
}

/* =============================================================================
   Golden Status (shared)
============================================================================= */
function GoldenStatus({ scheduled }) {
  const [now, setNow] = useState(Date.now());
  useEffect(() => {
    const id = setInterval(() => setNow(Date.now()), 1000);
    return () => clearInterval(id);
  }, []);
  const live = now >= scheduled.start && now <= scheduled.end;
  const timeTo = (ms) => {
    const diff = Math.max(0, ms - now);
    const m = Math.floor(diff / 60_000);
    const s = Math.floor((diff % 60_000) / 1000);
    return `${m}m ${s}s`;
  };
  return (
    <div className="rounded-xl bg-gradient-to-r from-yellow-100 to-amber-100 p-4 border">
      {!live && (
        <div>
          <div className="text-sm text-gray-600">Next Golden drop</div>
          <div className="text-xl font-bold">Starts in {timeTo(scheduled.start)}</div>
          <div className="text-sm">Hint: <span className="italic">{scheduled.hint}</span></div>
        </div>
      )}
      {live && (
        <div>
          <div className="text-sm text-gray-600">Golden Gnome is LIVE</div>
          <div className="text-xl font-bold">Ends in {timeTo(scheduled.end)}</div>
          <div className="text-sm">Target: #{scheduled.gnomeId} ‚Äî {GNOMES.find((g) => g.id === scheduled.gnomeId)?.venue}</div>
        </div>
      )}
    </div>
  );
}

/* =============================================================================
   App Shell
============================================================================= */
function TabButton({ active, onClick, children }) {
  return (
    <button
      onClick={onClick}
      className={`px-4 py-2 rounded-full border ${active ? "bg-black text-white" : "bg-white hover:bg-gray-50"}`}
    >
      {children}
    </button>
  );
}

export default function App() {
  const [tab, setTab] = useState("participant");
  return (
    <div className="min-h-screen bg-gradient-to-b from-white to-gray-50">
      <header className="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <div className="font-extrabold tracking-tight text-lg">WILDFLOWER √ó HYVE</div>
        <nav className="hidden md:flex gap-2">
          <TabButton active={tab === "participant"} onClick={() => setTab("participant")}>Participant</TabButton>
          <TabButton active={tab === "partner"} onClick={() => setTab("partner")}>Partner</TabButton>
          <TabButton active={tab === "admin"} onClick={() => setTab("admin")}>Admin</TabButton>
          <TabButton active={tab === "advertiser"} onClick={() => setTab("advertiser")}>Advertiser</TabButton>
        </nav>
        <button className="md:hidden rounded-full border px-3 py-1">Menu</button>
      </header>

      <main className="max-w-6xl mx-auto px-4 pb-24">
        {/* Hero */}
        <div className="my-6 rounded-3xl border p-6 bg-white shadow-sm">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h1 className="text-3xl md:text-4xl font-black">Find the Gnomes. Win Big.</h1>
              <p className="text-gray-600 mt-1">Scan, grin, and win across Jacksonville Beach.</p>
            </div>
            <div className="flex gap-2">
              <button onClick={() => setTab("participant")} className="rounded-lg bg-black text-white px-4 py-2">Join the Hunt</button>
              <a href="#how" className="rounded-lg border px-4 py-2">How it Works</a>
            </div>
          </div>
        </div>

        {/* Tabs (mobile) */}
        <div className="md:hidden flex gap-2 mb-4">
          <TabButton active={tab === "participant"} onClick={() => setTab("participant")}>Participant</TabButton>
          <TabButton active={tab === "partner"} onClick={() => setTab("partner")}>Partner</TabButton>
          <TabButton active={tab === "admin"} onClick={() => setTab("admin")}>Admin</TabButton>
          <TabButton active={tab === "advertiser"} onClick={() => setTab("advertiser")}>Advertiser</TabButton>
        </div>

        {tab === "participant" && <ParticipantApp />}
        {tab === "partner" && <PartnerPortal />}
        {tab === "admin" && <AdminTools />}
        {tab === "advertiser" && <AdvertiserPage />}

        {/* How it works */}
        <section id="how" className="mt-10 grid md:grid-cols-3 gap-4">
          <Card title="1) Find & Scan">
            <p className="text-sm text-gray-600">Look for co-branded gnome plaques across Jax Beach. Scan the QR to unlock clues.</p>
          </Card>
          <Card title="2) Upload Photo">
            <p className="text-sm text-gray-600">Upload a photo with each gnome. Your coupon is tied to the image for in-store verification.</p>
          </Card>
          <Card title="3) Redeem & Repeat">
            <p className="text-sm text-gray-600">Show your codes in-store. One-time redemptions are enforced by the advertiser portal.</p>
          </Card>
        </section>
      </main>

      <footer className="max-w-6xl mx-auto px-4 py-8 text-xs text-gray-500">
        ¬© {new Date().getFullYear()} WildFlower √ó Hyve ‚Äî Prototype for concept validation.
      </footer>
    </div>
  );
}